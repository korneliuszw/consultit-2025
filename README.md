G# ConsultIT Etap 1

## Running

Tested python version: 3.12
Use Linux or WSL for easier setup. PDF generation is very hard to setup on Windows because you have to
install (https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#windows)[MSYS2].

Install required system packages (Debian)

```bash
sudo apt install libsqlite3-dev python3-pip libpango-1.0-0 libharfbuzz0b libpangoft2-1.0-0 libharfbuzz-subset0 python3
```

If you are using pyenv and haven't installed libsqlite3 before, you need to reinstall your python version with pyenv
install

Install required libraries

```bash
pip install --user -r requirements.txt
```

To create a database with all the tables run

```bash
alembic upgrade head
```

Commands:

- createAdmin (login) (password): creates admin account with given login and password
- createSubscriptionPlans: creates subscriptions plans in database as proposed in the 1st problem of stage 2
- loadData: load CSV files into the database (monthly amount due is now ignored)
- generateInvoice (MM.YYYY): Generates invoices for a month and inserts them to database
- invoicesToCSV (MM.YYYY optional): Generates CSV for invoices. Omit a month to generate for all invoices in the
  database
- invoicesToPdf (MM.YYYY optional): Generates PDF for invoices. Omit a month to generate for all invoices in the
  database

You can run multiple commands but they are chained so make sure they follow a logical order

Example:

```bash
python ./main.py loadData generateInvoice "01.2025" invoicesToCSV invoicesToPdf
```

## Database

Diagram: https://dbdiagram.io/d/consultit-case-study-1-67d451b475d75cc8441eef71

For now, database is stored in hardcoded path ./network.db

# ConsultIT Etap 2

## API

To start the api run

```bash
fastapi run start_api.py
```

## Docs

Endpoint documentation is automatically generated by fastapi, in OpenAPI format with Swagger frontend. Once you start
the API, docs are available on /docs page.

## Testing

The problem asks the question how we are going to test the API before it's shipped to other development team.
Because the API is small and our team is small, we didn't have enough time to write all integration tests. If
this app was a real, production-ready solution we would have shipped them. As for now, we test the API using Swagger,
manually running changed endpoints and testing the results. We've added tests for downtime days calculation and formula
evalution as those are critical parts of the app that are the hardest to validate. It's not the best approach, but it's
the fastest one for
one-shot project like this.

Running these few tests we've written is done by

```bash
pytest
```

Mock database is created for every single test

## Users

For simplicity some assumptions were made for authentication and authorization.
Users can only have one role, either serviceman, consultant or admin. There can be only one active session, so they
can't be
logged in two places at once.
You can create users via /users POST request but you need to be logged in as admin.

### Auth

The app supports OAuth2. See swagger log in for reference. Authorization is done by storing scopes: ADMIN, SERVICEMAN,
CONSULTANT.

- ADMIN: Can do everything
- CONSULTANT: Has access to everything related to customers, subscription plans and invoices
- SERVICEMAN: Can see, modify and create downtimes

### Subscription plans

By default all existing customers (from csv or existing before) have empty subscription plan assigned. So generated
invoice will have value of exactly 0. To assign a subscription plan, send /customers/subscription POST request.

## Full example of running this project

```bash
alembic upgrade head
python main.py createAdmin admin admin loadData
python main.py createSubscriptionPlans
python main.py generateInvoice 01.2025 invoicesToCSV 01.2025 invoicesToPdf 01.2025
fastapi run start_api.py
```